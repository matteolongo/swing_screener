# Pre-Trade Explanation Engine (PTEE)

## Overview

The Pre-Trade Explanation Engine (PTEE) provides transparent, rule-based reasoning for every trade candidate generated by the screener. It answers the fundamental question: **"Why does this trade exist?"**

This is **not** an AI-driven system. It is a deterministic, glass-box engine that generates structured explanations based on quantifiable market data and systematic rules.

---

## Core Principle

**Explanation must be deterministic first, LLM-enhanced second.**

The pipeline is:
```
Strategy Rules â†’ Structured Facts â†’ Explanation Layer â†’ (Optional) LLM Simplifier
```

Facts come from the trading engine. LLMs (if used) only improve readability.

---

## Architecture

### 1. Trade Thesis Object

Every candidate trade produces a complete `TradeThesis` object containing:

```python
@dataclass
class TradeThesis:
    ticker: str
    strategy: str
    entry_type: str  # "Breakout + Pullback", "Breakout", "Pullback"
    
    # Market Position
    trend_status: str  # "Strong", "Moderate", "Developing", "Weak"
    relative_strength: str  # vs SPY: "Outperforming", "Inline", "Underperforming"
    regime_alignment: bool
    
    # Setup Characteristics
    volatility_state: str  # "Low", "Moderate", "High"
    risk_reward: float
    setup_quality_score: int  # 0-100
    setup_quality_tier: SetupQuality  # INSTITUTIONAL/HIGH_QUALITY/TRADABLE/WEAK
    
    # Classification
    safety_label: SafetyLabel  # BEGINNER_FRIENDLY/REQUIRES_DISCIPLINE/ADVANCED_ONLY
    personality: TradePersonality  # Star ratings for visualization
    
    # Explanation
    explanation: StructuredExplanation
    invalidation_rules: list[InvalidationRule]
    professional_insight: Optional[str]  # LLM-enhanced (future)
```

---

## Setup Quality Score (0-100)

The score is calculated from **5 weighted factors**:

### Scoring Breakdown

| Factor | Weight | Description |
|--------|--------|-------------|
| **Trend Alignment** | 30% | Distance from SMA200, above all SMAs |
| **Risk/Reward** | 25% | RR ratio (2.0+ required, 3.0+ ideal) |
| **Momentum** | 20% | 6m momentum + relative strength vs SPY |
| **Volatility** | 15% | ATR as % of price (1-2% ideal) |
| **Signal Quality** | 10% | Both signals = 10pts, single = 7pts + confidence bonus |

### Quality Tiers

| Score Range | Tier | Description |
|-------------|------|-------------|
| 90-100 | **Institutional-Grade** | Highest quality, all factors aligned |
| 75-89 | **High-Quality** | Strong setup, minor imperfections |
| 60-74 | **Tradable** | Acceptable, watch risk closely |
| <60 | **Weak** | Educational only, not recommended |

---

## Safety Classification

Trades are classified into **3 safety tiers**:

### ðŸŸ¢ Beginner-Friendly Setup
- Setup score â‰¥ 75
- Low volatility
- Both signals present
- RR â‰¥ 2.5
- Clear rules, simple execution

### ðŸŸ¡ Requires Discipline
- Standard setup quality
- Normal volatility
- Needs strict rule-following
- Most trades fall here

### ðŸ”´ Advanced Traders Only
- Low setup score (<60)
- High volatility
- Low RR (<2.0)
- Complex, requires experience

---

## Trade Personality

Visual 5-star ratings for quick cognition:

| Metric | Description | Calculation |
|--------|-------------|-------------|
| **Trend Strength** | â­â­â­â­â­ | Based on distance from SMA200 and trend status |
| **Volatility Control** | â­â­â­â­â­ | Inverse rating: 5 stars = low vol, 1 star = high vol |
| **System Conviction** | â­â­â­â­â­ | Based on confidence score (0-100) |
| **Complexity** | Text | "Beginner-friendly", "Intermediate", "Advanced" |

---

## Structured Explanation

### âœ… Why This Trade Appeared

Bullet-point reasons the candidate qualified:
- Stock in confirmed uptrend (above 20/50/200 SMA)
- Outperforming market benchmark
- Breaking to new highs with momentum
- Volatility within controlled levels
- RR exceeds minimum threshold

**Setup Type**: "Momentum Continuation Setup"

### âš ï¸ What Could Go Wrong

Risk factors to monitor:
- Breakouts can fail in weak market regimes
- If volatility expands, stop distance increases
- Momentum strategies depend on trend persistence
- Underperformance vs market may indicate weakness

### ðŸ’¡ Professional Insight

Educational, non-hype explanation in plain language:

> This trade is based on sustained strength rather than anticipation.
> The stock is proving demand by making new highs while outperforming the broader market.
> Controlled volatility allows for a clearly defined stop for risk management.

---

## Invalidation Rules

The system generates **specific conditions** that invalidate the thesis:

### Critical Rules

| Rule ID | Condition | Monitored Metric |
|---------|-----------|------------------|
| **STOP_BREACH** | Price closes below stop level | `close` |
| **BREAKOUT_FAILURE** | Price closes back below breakout level | `close` |
| **RELATIVE_STRENGTH_WEAK** | Relative strength weakens significantly vs SPY | `rel_strength < -0.10` |
| **TREND_BREAK** | Price breaks below SMA50 with high volume | `sma_50` |
| **REGIME_SHIFT** | Market regime shifts to risk-off | `regime` |

These rules teach **professional invalidation thinking**, not just "watch the stock."

---

## Implementation Details

### Backend Integration

The thesis is automatically generated in the screener pipeline:

```python
# In screener_service.py
rec_payload = evaluate_recommendation(
    # ... existing params
    ticker=ticker_str,
    close=last_price,
    sma_20=sma20,
    sma_50=sma50,
    sma_200=sma200,
    atr=atr,
    momentum_6m=momentum_6m,
    momentum_12m=momentum_12m,
    rel_strength=rel_strength,
    confidence=confidence,
)
# rec_payload.thesis now contains the complete TradeThesis
```

### Frontend Display

The thesis is displayed in a comprehensive modal accessed via the lightbulb icon (ðŸ’¡) in the screener results:

**Modal Sections:**
1. Setup Score & Safety Label
2. Trade Personality (star ratings)
3. Why This Trade Appeared
4. What Could Go Wrong
5. Professional Insight
6. Invalidation Rules
7. Trade Characteristics Summary

---

## Usage Example

### Viewing Trade Thesis

1. Run the screener from the Screener page
2. Results appear with candidates
3. Click the lightbulb icon (ðŸ’¡) on any candidate
4. The Trade Thesis modal opens with complete analysis

### Reading the Thesis

**Start with Setup Score:**
- Score 85 = High-Quality setup
- Tier: HIGH_QUALITY
- Safety: ðŸŸ¡ Requires Discipline

**Check Trade Personality:**
- Trend Strength: â­â­â­â­â­ (Strong)
- Volatility Control: â­â­â­â˜†â˜† (Moderate)
- System Conviction: â­â­â­â­â˜† (High)

**Read Why It Qualified:**
- Stock in confirmed uptrend
- Outperforming SPY
- Both signals active
- RR 3.2:1 exceeds minimum

**Understand the Risks:**
- Breakouts can fail
- Volatility may expand
- Depends on trend persistence

**Know When to Exit:**
- Stop breach at $145.00
- Breakout failure below $150.00
- Relative strength weakens vs SPY

---

## Testing

Comprehensive test suite in `tests/test_trade_thesis.py`:

- âœ… Setup score calculation (high/weak quality)
- âœ… Quality tier classification
- âœ… Safety label determination
- âœ… Volatility/trend classification
- âœ… Complete thesis building
- âœ… Serialization to dict
- âœ… Invalidation rules generation
- âœ… Trade personality ratings
- âœ… Structured explanation content

**All 16 tests pass.**

---

## Future Enhancements (Phase 2)

### Optional LLM Integration

The thesis can be enhanced with LLM-generated professional insights:

**Multi-Provider Support:**
- Ollama (local, free)
- OpenAI GPT-4
- Google Gemini

**LLM Usage:**
- Temperature near 0 (minimize hallucination)
- Prompt: "Explain this trade in 4 sentences for a beginner swing trader"
- No hype, no predictions, no certainty language
- Educational tone only

**Configuration:**
```json
{
  "llm": {
    "enabled": true,
    "provider": "ollama",
    "model": "llama3.2",
    "temperature": 0.1,
    "max_tokens": 200
  }
}
```

This is **Phase 2** and not yet implemented.

---

## Important Notes

### âŒ What PTEE Does NOT Do

- Does not predict future price movement
- Does not guarantee profitability
- Does not use AI to "invent" reasoning
- Does not hide decision logic

### âœ… What PTEE Does

- Provides transparent, rule-based explanations
- Quantifies setup quality objectively
- Classifies risk level for trader experience
- Generates specific invalidation rules
- Educates traders on systematic thinking

---

## Philosophy

The Pre-Trade Explanation Engine embodies the project's core values:

**Transparency over Magic**
- Glass box, not black box
- Every score is explainable
- Every rule is auditable

**Education over Hype**
- Teaches professional thinking
- Shows what could go wrong
- No certainty language

**Risk-First**
- Setup score includes volatility
- Safety labels protect beginners
- Invalidation rules = professional exits

---

## Related Documentation

- [OPERATIONAL_GUIDE.md](OPERATIONAL_GUIDE.md) - Daily usage
- [WEB_UI_GUIDE.md](WEB_UI_GUIDE.md) - UI features
- [AGENTS.md](../AGENTS.md) - Architecture overview

---

**Version**: v0.1.0  
**Last Updated**: February 2026
